<!--
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ€ TITO Ã‰PICO - WIDGET UNIFICADO PARA WORDPRESS
VersiÃ³n: 4.0 (Enero 2026)

INSTRUCCIONES:
1. CopiÃ¡ TODO este cÃ³digo
2. En WordPress â†’ WPCode â†’ Add New Snippet
3. Tipo: HTML Snippet
4. Location: Site Wide Footer
5. Activar y guardar

FEATURES:
âœ“ Productos con FOTOS en el chat
âœ“ Burbujas proactivas inteligentes por pÃ¡gina
âœ“ DetecciÃ³n de abandono de carrito
âœ“ ConexiÃ³n con WooCommerce en tiempo real
âœ“ Ayuda para finalizar compra
âœ“ Memoria del visitante
âœ“ GalerÃ­a deslizable de productos
âœ“ Responsive completo
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->

<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600&family=Cormorant+Garamond:ital,wght@0,400;0,500;1,400&display=swap');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VARIABLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
    --tito-dorado: #d4af37;
    --tito-dorado-claro: #e6c860;
    --tito-dorado-oscuro: #b8960c;
    --tito-negro: #0a0a0a;
    --tito-negro-suave: #1a1a1a;
    --tito-blanco: rgba(255,255,255,0.9);
    --tito-blanco-suave: rgba(255,255,255,0.6);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONTENEDOR PRINCIPAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tito-widget {
    position: fixed !important;
    bottom: 25px !important;
    right: 25px !important;
    z-index: 999999 !important;
    font-family: 'Cormorant Garamond', Georgia, serif !important;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTÃ“N FLOTANTE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tito-toggle {
    width: 75px !important;
    height: 75px !important;
    background: linear-gradient(135deg, var(--tito-negro-suave) 0%, var(--tito-negro) 100%) !important;
    border: 2px solid var(--tito-dorado) !important;
    border-radius: 50% !important;
    cursor: pointer !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    box-shadow: 0 5px 30px rgba(0,0,0,0.4), 0 0 25px rgba(212,175,55,0.25) !important;
    transition: all 0.3s ease !important;
    position: relative !important;
    animation: titoFloat 3s ease-in-out infinite !important;
    padding: 0 !important;
    overflow: hidden !important;
}

.tito-toggle img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    border-radius: 50% !important;
}

.tito-toggle:hover {
    transform: scale(1.1) !important;
    animation: none !important;
    box-shadow: 0 8px 40px rgba(0,0,0,0.5), 0 0 40px rgba(212,175,55,0.4) !important;
}

@keyframes titoFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-6px); }
}

/* NotificaciÃ³n */
.tito-notif {
    position: absolute !important;
    top: -5px !important;
    right: -5px !important;
    width: 24px !important;
    height: 24px !important;
    background: var(--tito-dorado) !important;
    color: var(--tito-negro) !important;
    font-size: 12px !important;
    font-weight: 700 !important;
    border-radius: 50% !important;
    display: none;
    align-items: center !important;
    justify-content: center !important;
    animation: titoPulse 2s infinite !important;
}

@keyframes titoPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.15); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BURBUJA PROACTIVA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tito-burbuja {
    position: absolute !important;
    bottom: 95px !important;
    right: 0 !important;
    width: 320px !important;
    background: linear-gradient(135deg, var(--tito-negro-suave), var(--tito-negro)) !important;
    border: 1px solid rgba(212,175,55,0.4) !important;
    border-radius: 18px !important;
    padding: 18px 20px !important;
    box-shadow: 0 15px 50px rgba(0,0,0,0.5), 0 0 25px rgba(212,175,55,0.15) !important;
    opacity: 0 !important;
    visibility: hidden !important;
    transform: translateY(15px) scale(0.95) !important;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.tito-burbuja.visible {
    opacity: 1 !important;
    visibility: visible !important;
    transform: translateY(0) scale(1) !important;
}

.tito-burbuja::after {
    content: '' !important;
    position: absolute !important;
    bottom: -10px !important;
    right: 28px !important;
    border-left: 10px solid transparent !important;
    border-right: 10px solid transparent !important;
    border-top: 10px solid var(--tito-negro-suave) !important;
}

.tito-burbuja-close {
    position: absolute !important;
    top: 10px !important;
    right: 12px !important;
    background: none !important;
    border: none !important;
    color: var(--tito-blanco-suave) !important;
    font-size: 20px !important;
    cursor: pointer !important;
    padding: 0 !important;
    line-height: 1 !important;
    transition: color 0.2s !important;
}

.tito-burbuja-close:hover {
    color: #fff !important;
}

.tito-burbuja-texto {
    color: var(--tito-blanco) !important;
    font-size: 15px !important;
    line-height: 1.55 !important;
    margin: 0 0 15px 0 !important;
    padding-right: 25px !important;
}

.tito-burbuja-texto strong {
    color: var(--tito-dorado-claro) !important;
}

/* Botones de burbuja */
.tito-burbuja-botones {
    display: flex !important;
    gap: 10px !important;
    flex-wrap: wrap !important;
}

.tito-burbuja-btn {
    flex: 1 !important;
    min-width: 100px !important;
    background: rgba(212,175,55,0.12) !important;
    border: 1px solid rgba(212,175,55,0.4) !important;
    color: var(--tito-dorado) !important;
    padding: 11px 14px !important;
    border-radius: 25px !important;
    font-family: 'Cormorant Garamond', serif !important;
    font-size: 13px !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    text-align: center !important;
}

.tito-burbuja-btn:hover {
    background: rgba(212,175,55,0.22) !important;
    border-color: var(--tito-dorado) !important;
}

.tito-burbuja-btn.primary {
    background: linear-gradient(135deg, var(--tito-dorado), var(--tito-dorado-oscuro)) !important;
    color: var(--tito-negro) !important;
    border: none !important;
    font-weight: 600 !important;
}

.tito-burbuja-btn.primary:hover {
    box-shadow: 0 5px 20px rgba(212,175,55,0.4) !important;
    transform: scale(1.02) !important;
}

/* Mini galerÃ­a en burbuja */
.tito-burbuja-galeria {
    display: flex !important;
    gap: 10px !important;
    margin-bottom: 15px !important;
    overflow-x: auto !important;
    padding-bottom: 5px !important;
    scrollbar-width: none !important;
}

.tito-burbuja-galeria::-webkit-scrollbar {
    display: none !important;
}

.tito-burbuja-producto {
    flex-shrink: 0 !important;
    width: 90px !important;
    text-align: center !important;
    cursor: pointer !important;
    transition: transform 0.2s !important;
}

.tito-burbuja-producto:hover {
    transform: scale(1.05) !important;
}

.tito-burbuja-producto img {
    width: 80px !important;
    height: 80px !important;
    object-fit: cover !important;
    border-radius: 10px !important;
    border: 1px solid rgba(212,175,55,0.3) !important;
}

.tito-burbuja-producto-nombre {
    font-size: 11px !important;
    color: var(--tito-blanco-suave) !important;
    margin-top: 5px !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VENTANA DE CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tito-window {
    position: absolute !important;
    bottom: 95px !important;
    right: 0 !important;
    width: 400px !important;
    height: 580px !important;
    background: linear-gradient(180deg, #12151a 0%, #0a0c10 100%) !important;
    border: 1px solid rgba(212,175,55,0.3) !important;
    border-radius: 25px !important;
    overflow: hidden !important;
    opacity: 0 !important;
    visibility: hidden !important;
    transform: translateY(20px) scale(0.95) !important;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
    box-shadow: 0 30px 80px rgba(0,0,0,0.6) !important;
    display: flex !important;
    flex-direction: column !important;
}

.tito-window.visible {
    opacity: 1 !important;
    visibility: visible !important;
    transform: translateY(0) scale(1) !important;
}

/* Header del chat */
.tito-header {
    background: linear-gradient(135deg, rgba(212,175,55,0.15), rgba(212,175,55,0.05)) !important;
    border-bottom: 1px solid rgba(212,175,55,0.2) !important;
    padding: 16px 20px !important;
    display: flex !important;
    align-items: center !important;
    gap: 14px !important;
}

.tito-avatar {
    width: 52px !important;
    height: 52px !important;
    border-radius: 50% !important;
    overflow: hidden !important;
    flex-shrink: 0 !important;
    box-shadow: 0 0 15px rgba(212,175,55,0.35) !important;
    border: 2px solid rgba(212,175,55,0.4) !important;
}

.tito-avatar img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
}

.tito-info h4 {
    font-family: 'Cinzel', serif !important;
    font-size: 16px !important;
    color: #fff !important;
    font-weight: 600 !important;
    margin: 0 0 3px 0 !important;
}

.tito-info p {
    font-size: 13px !important;
    color: var(--tito-blanco-suave) !important;
    margin: 0 !important;
    display: flex !important;
    align-items: center !important;
    gap: 6px !important;
}

.tito-status {
    display: inline-block !important;
    width: 8px !important;
    height: 8px !important;
    background: #4ade80 !important;
    border-radius: 50% !important;
    animation: titoStatusPulse 2s infinite !important;
}

@keyframes titoStatusPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.tito-close {
    margin-left: auto !important;
    background: none !important;
    border: none !important;
    color: var(--tito-blanco-suave) !important;
    font-size: 28px !important;
    cursor: pointer !important;
    padding: 0 !important;
    line-height: 1 !important;
    transition: color 0.2s !important;
}

.tito-close:hover {
    color: #fff !important;
}

/* Ãrea de mensajes */
.tito-messages {
    flex: 1 !important;
    overflow-y: auto !important;
    padding: 18px !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 14px !important;
}

.tito-messages::-webkit-scrollbar {
    width: 5px !important;
}

.tito-messages::-webkit-scrollbar-thumb {
    background: rgba(212,175,55,0.3) !important;
    border-radius: 3px !important;
}

/* Mensajes */
.tito-msg {
    max-width: 85% !important;
    padding: 13px 17px !important;
    border-radius: 18px !important;
    font-size: 15px !important;
    line-height: 1.55 !important;
    animation: titoMsgIn 0.3s ease !important;
}

@keyframes titoMsgIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.tito-msg.bot {
    background: rgba(212,175,55,0.1) !important;
    border: 1px solid rgba(212,175,55,0.2) !important;
    color: var(--tito-blanco) !important;
    align-self: flex-start !important;
    border-bottom-left-radius: 5px !important;
}

.tito-msg.user {
    background: linear-gradient(135deg, var(--tito-dorado), var(--tito-dorado-oscuro)) !important;
    color: var(--tito-negro) !important;
    align-self: flex-end !important;
    border-bottom-right-radius: 5px !important;
}

/* Typing indicator */
.tito-msg.typing {
    display: flex !important;
    gap: 5px !important;
    padding: 16px 22px !important;
}

.tito-msg.typing span {
    width: 8px !important;
    height: 8px !important;
    background: var(--tito-dorado) !important;
    border-radius: 50% !important;
    animation: titoTyping 1.4s infinite !important;
}

.tito-msg.typing span:nth-child(2) { animation-delay: 0.2s !important; }
.tito-msg.typing span:nth-child(3) { animation-delay: 0.4s !important; }

@keyframes titoTyping {
    0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
    30% { opacity: 1; transform: translateY(-5px); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GALERÃA DE PRODUCTOS EN CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tito-galeria {
    display: flex !important;
    gap: 12px !important;
    overflow-x: auto !important;
    padding: 12px 0 !important;
    margin-top: 10px !important;
    scroll-behavior: smooth !important;
    scrollbar-width: none !important;
}

.tito-galeria::-webkit-scrollbar {
    display: none !important;
}

.tito-galeria-card {
    flex-shrink: 0 !important;
    width: 150px !important;
    background: rgba(0,0,0,0.5) !important;
    border: 1px solid rgba(212,175,55,0.3) !important;
    border-radius: 14px !important;
    overflow: hidden !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    text-decoration: none !important;
}

.tito-galeria-card:hover {
    border-color: var(--tito-dorado) !important;
    transform: translateY(-4px) !important;
    box-shadow: 0 10px 30px rgba(0,0,0,0.4), 0 0 20px rgba(212,175,55,0.2) !important;
}

.tito-galeria-card img {
    width: 150px !important;
    height: 110px !important;
    object-fit: cover !important;
    display: block !important;
    background: #222 !important;
}

.tito-galeria-info {
    padding: 10px !important;
}

.tito-galeria-nombre {
    font-family: 'Cinzel', serif !important;
    font-size: 12px !important;
    color: #fff !important;
    margin: 0 0 5px 0 !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}

.tito-galeria-precio {
    font-size: 14px !important;
    color: var(--tito-dorado) !important;
    font-weight: 600 !important;
    margin: 0 !important;
}

.tito-galeria-btn {
    display: block !important;
    text-align: center !important;
    background: rgba(212,175,55,0.2) !important;
    color: var(--tito-dorado) !important;
    font-size: 11px !important;
    padding: 7px !important;
    margin-top: 8px !important;
    border-radius: 6px !important;
    transition: background 0.2s !important;
}

.tito-galeria-card:hover .tito-galeria-btn {
    background: rgba(212,175,55,0.35) !important;
}

.tito-galeria-hint {
    font-size: 11px !important;
    color: var(--tito-blanco-suave) !important;
    text-align: center !important;
    margin-top: 6px !important;
    opacity: 0.7 !important;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUGERENCIAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tito-suggestions {
    padding: 0 18px 12px !important;
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 8px !important;
}

.tito-suggestion {
    background: rgba(212,175,55,0.1) !important;
    border: 1px solid rgba(212,175,55,0.25) !important;
    border-radius: 20px !important;
    padding: 8px 14px !important;
    font-size: 13px !important;
    color: var(--tito-blanco) !important;
    cursor: pointer !important;
    transition: all 0.2s !important;
}

.tito-suggestion:hover {
    background: rgba(212,175,55,0.2) !important;
    border-color: var(--tito-dorado) !important;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tito-input-container {
    padding: 14px 18px 18px !important;
    border-top: 1px solid rgba(212,175,55,0.2) !important;
    display: flex !important;
    gap: 10px !important;
    background: rgba(0,0,0,0.3) !important;
}

.tito-input {
    flex: 1 !important;
    background: rgba(255,255,255,0.06) !important;
    border: 1px solid rgba(212,175,55,0.3) !important;
    border-radius: 25px !important;
    padding: 13px 20px !important;
    font-family: 'Cormorant Garamond', serif !important;
    font-size: 16px !important;
    color: #fff !important;
    outline: none !important;
}

.tito-input::placeholder {
    color: var(--tito-blanco-suave) !important;
}

.tito-input:focus {
    border-color: var(--tito-dorado) !important;
}

.tito-send {
    width: 50px !important;
    height: 50px !important;
    background: linear-gradient(135deg, var(--tito-dorado), var(--tito-dorado-oscuro)) !important;
    border: none !important;
    border-radius: 50% !important;
    cursor: pointer !important;
    font-size: 20px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    flex-shrink: 0 !important;
    transition: all 0.2s !important;
}

.tito-send:hover:not(:disabled) {
    transform: scale(1.05) !important;
    box-shadow: 0 5px 20px rgba(212,175,55,0.4) !important;
}

.tito-send:disabled {
    opacity: 0.5 !important;
    cursor: not-allowed !important;
}

/* Footer */
.tito-footer {
    text-align: center !important;
    padding: 8px !important;
    font-size: 10px !important;
    color: rgba(255,255,255,0.25) !important;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 500px) {
    .tito-widget {
        bottom: 15px !important;
        right: 15px !important;
    }

    .tito-toggle {
        width: 65px !important;
        height: 65px !important;
    }

    .tito-window {
        width: calc(100vw - 30px) !important;
        height: 70vh !important;
        right: -7px !important;
        bottom: 80px !important;
        max-height: 550px !important;
    }

    .tito-burbuja {
        width: 280px !important;
        right: -7px !important;
        bottom: 80px !important;
    }

    .tito-galeria-card {
        width: 130px !important;
    }

    .tito-galeria-card img {
        width: 130px !important;
        height: 95px !important;
    }
}
</style>

<div class="tito-widget" id="titoWidget">
    <!-- Burbuja proactiva -->
    <div class="tito-burbuja" id="titoBurbuja">
        <button class="tito-burbuja-close" id="titoBurbujaClose">Ã—</button>
        <div id="titoBurbujaGaleria" class="tito-burbuja-galeria" style="display:none;"></div>
        <p class="tito-burbuja-texto" id="titoBurbujaTexto"></p>
        <div class="tito-burbuja-botones" id="titoBurbujaBotones"></div>
    </div>

    <!-- BotÃ³n flotante -->
    <button class="tito-toggle" id="titoToggle">
        <img src="https://duendesuy.10web.cloud/wp-content/uploads/2025/12/gemini-image-2_que_tenga_un_pin_en_su_ropa_con_este_logo_en_negro_y_dorado_solo_el_circulo_que_-0_b02c570f-fd54-4b54-b306-3aa6a2b413b2-scaled.jpg" alt="Tito">
        <span class="tito-notif" id="titoNotif">1</span>
    </button>

    <!-- Ventana de chat -->
    <div class="tito-window" id="titoWindow">
        <div class="tito-header">
            <div class="tito-avatar">
                <img src="https://duendesuy.10web.cloud/wp-content/uploads/2025/12/gemini-image-2_que_tenga_un_pin_en_su_ropa_con_este_logo_en_negro_y_dorado_solo_el_circulo_que_-0_b02c570f-fd54-4b54-b306-3aa6a2b413b2-scaled.jpg" alt="Tito">
            </div>
            <div class="tito-info">
                <h4>Tito</h4>
                <p><span class="tito-status"></span> GuardiÃ¡n Digital</p>
            </div>
            <button class="tito-close" id="titoClose">Ã—</button>
        </div>

        <div class="tito-messages" id="titoMessages"></div>

        <div class="tito-suggestions" id="titoSuggestions">
            <button class="tito-suggestion" data-text="Quiero un duende de protecciÃ³n">ProtecciÃ³n ğŸ›¡ï¸</button>
            <button class="tito-suggestion" data-text="Busco abundancia y prosperidad">Abundancia ğŸ’°</button>
            <button class="tito-suggestion" data-text="Â¿CÃ³mo es el proceso de compra?">Â¿CÃ³mo compro? ğŸ›’</button>
        </div>

        <div class="tito-input-container">
            <input type="text" class="tito-input" id="titoInput" placeholder="EscribÃ­ tu mensaje..." maxlength="500">
            <button class="tito-send" id="titoSend">â¤</button>
        </div>

        <div class="tito-footer">âœ¨ Magia ancestral desde PiriÃ¡polis</div>
    </div>
</div>

<script>
(function() {
    'use strict';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIGURACIÃ“N
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const CONFIG = {
        API_BASE: 'https://duendes-vercel.vercel.app',
        TITO_AVATAR: 'https://duendesuy.10web.cloud/wp-content/uploads/2025/12/gemini-image-2_que_tenga_un_pin_en_su_ropa_con_este_logo_en_negro_y_dorado_solo_el_circulo_que_-0_b02c570f-fd54-4b54-b306-3aa6a2b413b2-scaled.jpg',

        // Tiempos para burbujas (ms)
        TIEMPO_PRODUCTO: 12000,      // 12 seg en pÃ¡gina de producto
        TIEMPO_TIENDA: 20000,        // 20 seg en tienda
        TIEMPO_CARRITO: 8000,        // 8 seg en carrito
        TIEMPO_CHECKOUT: 25000,      // 25 seg en checkout
        TIEMPO_GENERAL: 30000,       // 30 seg en otras pÃ¡ginas
        TIEMPO_ABANDONO: 60000,      // 60 seg sin actividad

        // URLs
        URL_CARRITO: '/carrito/',
        URL_CHECKOUT: '/caja/',
        URL_TIENDA: '/tienda/'
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ESTADO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const estado = {
        chatAbierto: false,
        conversationHistory: [],
        isWaiting: false,
        visitorId: null,
        tiempoPagina: 0,
        ultimaActividad: Date.now(),
        burbujasMostradas: {},
        interactuoConTito: false,
        paginaActual: null,
        productoActual: null,
        carritoItems: [],
        carritoCount: 0
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ELEMENTOS DOM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let els = {};

    function initElements() {
        els = {
            widget: document.getElementById('titoWidget'),
            toggle: document.getElementById('titoToggle'),
            window: document.getElementById('titoWindow'),
            close: document.getElementById('titoClose'),
            messages: document.getElementById('titoMessages'),
            input: document.getElementById('titoInput'),
            send: document.getElementById('titoSend'),
            suggestions: document.getElementById('titoSuggestions'),
            notif: document.getElementById('titoNotif'),
            burbuja: document.getElementById('titoBurbuja'),
            burbujaTexto: document.getElementById('titoBurbujaTexto'),
            burbujaBotones: document.getElementById('titoBurbujaBotones'),
            burbujaGaleria: document.getElementById('titoBurbujaGaleria'),
            burbujaClose: document.getElementById('titoBurbujaClose')
        };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UTILIDADES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function getVisitorId() {
        let id = localStorage.getItem('tito_visitor_id');
        if (!id) {
            id = 'v_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('tito_visitor_id', id);
        }
        return id;
    }

    function detectarPagina() {
        const path = window.location.pathname;
        const body = document.body;

        if (body.classList.contains('single-product') || path.includes('/producto/') || path.includes('/product/')) {
            return 'producto';
        }
        if (path.includes('/carrito') || path.includes('/cart') || body.classList.contains('woocommerce-cart')) {
            return 'carrito';
        }
        if (path.includes('/caja') || path.includes('/checkout') || body.classList.contains('woocommerce-checkout')) {
            return 'checkout';
        }
        if (body.classList.contains('woocommerce-shop') || body.classList.contains('post-type-archive-product') ||
            body.classList.contains('tax-product_cat') || path.includes('/tienda') || path.includes('/shop')) {
            return 'tienda';
        }
        return 'general';
    }

    function obtenerProductoActual() {
        if (estado.paginaActual !== 'producto') return null;

        const titulo = document.querySelector('.product_title, .entry-title, h1.elementor-heading-title');
        const precio = document.querySelector('.price .woocommerce-Price-amount, .price ins .amount');
        const imagen = document.querySelector('.woocommerce-product-gallery__image img, .wp-post-image');

        if (titulo) {
            return {
                nombre: titulo.textContent.trim(),
                precio: precio ? precio.textContent.trim() : null,
                imagen: imagen ? imagen.src : null,
                url: window.location.href
            };
        }
        return null;
    }

    function obtenerCarritoWoo() {
        // Intentar obtener del localStorage de WooCommerce o del DOM
        const carritoCount = document.querySelector('.cart-contents-count, .cart-count, .wc-block-mini-cart__badge');
        if (carritoCount) {
            estado.carritoCount = parseInt(carritoCount.textContent) || 0;
        }

        // Obtener items del carrito si estamos en la pÃ¡gina del carrito
        if (estado.paginaActual === 'carrito') {
            const items = document.querySelectorAll('.woocommerce-cart-form__cart-item, .cart_item');
            estado.carritoItems = Array.from(items).map(item => {
                const nombre = item.querySelector('.product-name a');
                const precio = item.querySelector('.product-price .amount');
                const img = item.querySelector('img');
                return {
                    nombre: nombre ? nombre.textContent.trim() : 'Producto',
                    precio: precio ? precio.textContent.trim() : '',
                    imagen: img ? img.src : null
                };
            });
        }

        return estado.carritoCount;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // API CALLS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function enviarMensaje(mensaje) {
        const contexto = {
            pagina: estado.paginaActual,
            producto: estado.productoActual,
            carrito: estado.carritoCount,
            tiempoEnPagina: estado.tiempoPagina,
            url: window.location.href
        };

        try {
            const response = await fetch(`${CONFIG.API_BASE}/api/tito/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: mensaje,
                    history: estado.conversationHistory.slice(-8),
                    contexto,
                    visitorId: estado.visitorId
                })
            });

            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error Tito:', error);
            return {
                success: false,
                response: 'DisculpÃ¡, tuve un problemita. Â¿PodÃ©s intentar de nuevo?'
            };
        }
    }

    async function obtenerProductosRecomendados(params = {}) {
        try {
            let url = `${CONFIG.API_BASE}/api/tito/woo?accion=recomendaciones`;
            if (params.intencion) url += `&intencion=${encodeURIComponent(params.intencion)}`;
            if (params.presupuesto) url += `&presupuesto=${params.presupuesto}`;

            const response = await fetch(url);
            const data = await response.json();
            return data.success ? data.data : [];
        } catch (error) {
            console.error('Error obteniendo productos:', error);
            return [];
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI - MENSAJES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function agregarMensaje(texto, tipo, productos = []) {
        const msg = document.createElement('div');
        msg.className = `tito-msg ${tipo}`;
        msg.innerHTML = texto;
        els.messages.appendChild(msg);

        // Si hay productos, agregar galerÃ­a
        if (productos && productos.length > 0) {
            const galeria = crearGaleria(productos);
            els.messages.appendChild(galeria);
        }

        els.messages.scrollTop = els.messages.scrollHeight;
    }

    function crearGaleria(productos) {
        const container = document.createElement('div');
        container.className = 'tito-galeria';

        productos.forEach(p => {
            const card = document.createElement('a');
            card.className = 'tito-galeria-card';
            card.href = p.url || '#';
            card.target = '_blank';
            card.innerHTML = `
                <img src="${p.imagen || CONFIG.TITO_AVATAR}" alt="${p.nombre}" onerror="this.src='${CONFIG.TITO_AVATAR}'">
                <div class="tito-galeria-info">
                    <p class="tito-galeria-nombre">${p.nombre}</p>
                    <p class="tito-galeria-precio">$${p.precio} USD</p>
                    <span class="tito-galeria-btn">Ver guardiÃ¡n âœ¨</span>
                </div>
            `;
            container.appendChild(card);
        });

        // Hint de scroll si hay mÃ¡s de 2
        if (productos.length > 2) {
            const hint = document.createElement('div');
            hint.className = 'tito-galeria-hint';
            hint.textContent = 'â† DeslizÃ¡ para ver mÃ¡s â†’';
            container.appendChild(hint);
        }

        return container;
    }

    function mostrarTyping() {
        const typing = document.createElement('div');
        typing.className = 'tito-msg bot typing';
        typing.id = 'titoTyping';
        typing.innerHTML = '<span></span><span></span><span></span>';
        els.messages.appendChild(typing);
        els.messages.scrollTop = els.messages.scrollHeight;
    }

    function ocultarTyping() {
        const typing = document.getElementById('titoTyping');
        if (typing) typing.remove();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI - BURBUJAS PROACTIVAS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function mostrarBurbuja(config) {
        if (estado.chatAbierto || estado.interactuoConTito) return;
        if (els.burbuja.classList.contains('visible')) return;

        // GalerÃ­a opcional
        if (config.productos && config.productos.length > 0) {
            els.burbujaGaleria.innerHTML = '';
            config.productos.slice(0, 3).forEach(p => {
                const item = document.createElement('div');
                item.className = 'tito-burbuja-producto';
                item.innerHTML = `
                    <img src="${p.imagen || CONFIG.TITO_AVATAR}" alt="${p.nombre}" onerror="this.src='${CONFIG.TITO_AVATAR}'">
                    <div class="tito-burbuja-producto-nombre">${p.nombre}</div>
                `;
                item.onclick = () => window.open(p.url, '_blank');
                els.burbujaGaleria.appendChild(item);
            });
            els.burbujaGaleria.style.display = 'flex';
        } else {
            els.burbujaGaleria.style.display = 'none';
        }

        // Texto
        els.burbujaTexto.innerHTML = config.texto;

        // Botones
        els.burbujaBotones.innerHTML = '';
        config.botones.forEach(btn => {
            const boton = document.createElement('button');
            boton.className = `tito-burbuja-btn${btn.primary ? ' primary' : ''}`;
            boton.textContent = btn.texto;
            boton.onclick = () => {
                ocultarBurbuja();
                if (btn.accion === 'chat') {
                    abrirChat();
                    if (btn.mensaje) {
                        setTimeout(() => {
                            els.input.value = btn.mensaje;
                            procesarEnvio();
                        }, 300);
                    }
                } else if (btn.accion === 'url') {
                    window.location.href = btn.url;
                } else if (btn.accion === 'cerrar') {
                    // Solo cerrar
                }
            };
            els.burbujaBotones.appendChild(boton);
        });

        els.burbuja.classList.add('visible');

        // Auto-cerrar despuÃ©s de 20 segundos
        setTimeout(ocultarBurbuja, 20000);
    }

    function ocultarBurbuja() {
        els.burbuja.classList.remove('visible');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BURBUJAS POR CONTEXTO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const BURBUJAS = {
        producto: [
            {
                delay: 12000,
                config: () => ({
                    texto: `âœ¨ Este guardiÃ¡n es <strong>Ãºnico en el mundo</strong>... cuando se va, desaparece para siempre.`,
                    botones: [
                        { texto: 'ğŸ’œ Contame mÃ¡s', primary: true, accion: 'chat' },
                        { texto: 'Sigo mirando', accion: 'cerrar' }
                    ]
                })
            },
            {
                delay: 35000,
                config: () => ({
                    texto: `ğŸ”® Â¿SabÃ­as que cada duende tiene su propia historia y personalidad? Si sentiste algo al verlo, <strong>no es casualidad</strong>.`,
                    botones: [
                        { texto: 'Â¿CuÃ¡l es su historia?', primary: true, accion: 'chat', mensaje: 'Â¿CuÃ¡l es la historia de este guardiÃ¡n?' },
                        { texto: 'DespuÃ©s', accion: 'cerrar' }
                    ]
                })
            },
            {
                delay: 70000,
                config: () => ({
                    texto: `ğŸ’« Â¿El precio es un obstÃ¡culo? Con solo el <strong>30% lo reservÃ¡s por 30 dÃ­as</strong>...`,
                    botones: [
                        { texto: 'Â¿CÃ³mo funciona?', primary: true, accion: 'chat', mensaje: 'Â¿CÃ³mo funciona el sistema de seÃ±a?' },
                        { texto: 'No, gracias', accion: 'cerrar' }
                    ]
                })
            }
        ],

        tienda: [
            {
                delay: 20000,
                config: async () => {
                    const productos = await obtenerProductosRecomendados({});
                    return {
                        texto: `ğŸ”® Â¿BuscÃ¡s algo especÃ­fico? Puedo ayudarte a encontrar el guardiÃ¡n <strong>perfecto para vos</strong>.`,
                        productos: productos.slice(0, 3),
                        botones: [
                            { texto: 'SÃ­, ayudame', primary: true, accion: 'chat' },
                            { texto: 'Solo miro', accion: 'cerrar' }
                        ]
                    };
                }
            },
            {
                delay: 50000,
                config: () => ({
                    texto: `âœ¨ Â¿ProtecciÃ³n, abundancia, amor o sanaciÃ³n? Cada guardiÃ¡n tiene un propÃ³sito especial...`,
                    botones: [
                        { texto: 'ğŸ›¡ï¸ ProtecciÃ³n', accion: 'chat', mensaje: 'Busco un guardiÃ¡n de protecciÃ³n' },
                        { texto: 'ğŸ’° Abundancia', accion: 'chat', mensaje: 'Busco un guardiÃ¡n de abundancia' },
                        { texto: 'ğŸ’œ Amor', accion: 'chat', mensaje: 'Busco un guardiÃ¡n de amor' }
                    ]
                })
            }
        ],

        carrito: [
            {
                delay: 8000,
                config: () => ({
                    texto: `ğŸ€ Â¡Excelente elecciÃ³n! Tus guardianes ya estÃ¡n ansiosos por conocerte...`,
                    botones: [
                        { texto: 'ğŸ›’ Completar compra', primary: true, accion: 'url', url: CONFIG.URL_CHECKOUT },
                        { texto: 'Tengo dudas', accion: 'chat' }
                    ]
                })
            },
            {
                delay: 40000,
                config: () => ({
                    texto: `âš¡ RecordÃ¡: son piezas <strong>Ãºnicas</strong>. Si alguien mÃ¡s las adopta mientras tanto, desaparecen para siempre...`,
                    botones: [
                        { texto: 'Voy a pagar', primary: true, accion: 'url', url: CONFIG.URL_CHECKOUT },
                        { texto: 'Â¿Puedo reservar?', accion: 'chat', mensaje: 'Â¿Puedo reservar con una seÃ±a?' }
                    ]
                })
            }
        ],

        checkout: [
            {
                delay: 25000,
                config: () => ({
                    texto: `ğŸ“ Â¿Todo bien con el formulario? Estoy acÃ¡ si necesitÃ¡s ayuda.`,
                    botones: [
                        { texto: 'Tengo una duda', primary: true, accion: 'chat' },
                        { texto: 'Todo bien', accion: 'cerrar' }
                    ]
                })
            }
        ],

        general: [
            {
                delay: 30000,
                config: () => ({
                    texto: `âœ¨ Â¡Hola! Soy Tito, el guardiÃ¡n digital. Si llegaste hasta acÃ¡, <strong>no es casualidad</strong>...`,
                    botones: [
                        { texto: 'Contame mÃ¡s', primary: true, accion: 'chat' },
                        { texto: 'Ver tienda', accion: 'url', url: CONFIG.URL_TIENDA }
                    ]
                })
            }
        ]
    };

    function iniciarBurbujas() {
        const burbujas = BURBUJAS[estado.paginaActual] || BURBUJAS.general;

        burbujas.forEach((burbuja, index) => {
            const key = `${estado.paginaActual}_${index}`;
            if (estado.burbujasMostradas[key]) return;

            setTimeout(async () => {
                if (estado.chatAbierto || estado.interactuoConTito) return;
                if (estado.burbujasMostradas[key]) return;

                estado.burbujasMostradas[key] = true;

                const config = typeof burbuja.config === 'function'
                    ? await burbuja.config()
                    : burbuja.config;

                mostrarBurbuja(config);
            }, burbuja.delay);
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DETECCIÃ“N DE ABANDONO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function iniciarDeteccionAbandono() {
        let abandonoTimeout = null;

        function resetearAbandono() {
            estado.ultimaActividad = Date.now();
            if (abandonoTimeout) clearTimeout(abandonoTimeout);

            abandonoTimeout = setTimeout(() => {
                if (estado.carritoCount > 0 && !estado.chatAbierto && !estado.interactuoConTito) {
                    mostrarBurbuja({
                        texto: `ğŸ’­ Â¿Te fuiste? Tus guardianes siguen esperÃ¡ndote... No dejes que otro los adopte ğŸ€`,
                        botones: [
                            { texto: 'Ver mi carrito', primary: true, accion: 'url', url: CONFIG.URL_CARRITO },
                            { texto: 'Tengo dudas', accion: 'chat' }
                        ]
                    });
                }
            }, CONFIG.TIEMPO_ABANDONO);
        }

        // Eventos de actividad
        ['mousemove', 'keydown', 'scroll', 'click', 'touchstart'].forEach(event => {
            document.addEventListener(event, resetearAbandono, { passive: true });
        });

        resetearAbandono();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CHAT HANDLERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function abrirChat() {
        estado.chatAbierto = true;
        els.window.classList.add('visible');
        ocultarBurbuja();
        els.notif.style.display = 'none';
        els.input.focus();

        // Mensaje de bienvenida si es primera vez
        if (estado.conversationHistory.length === 0) {
            const saludo = estado.paginaActual === 'producto' && estado.productoActual
                ? `Â¡Hola! Veo que estÃ¡s mirando a <strong>${estado.productoActual.nombre}</strong>... Â¿QuerÃ©s que te cuente sobre este guardiÃ¡n? ğŸ€`
                : 'Â¡Hola! Soy Tito, el guardiÃ¡n digital de Duendes del Uruguay. Â¿En quÃ© puedo ayudarte hoy? âœ¨';

            agregarMensaje(saludo, 'bot');
        }
    }

    function cerrarChat() {
        estado.chatAbierto = false;
        els.window.classList.remove('visible');
    }

    async function procesarEnvio() {
        const mensaje = els.input.value.trim();
        if (!mensaje || estado.isWaiting) return;

        estado.interactuoConTito = true;
        estado.isWaiting = true;
        els.send.disabled = true;
        els.input.value = '';
        els.suggestions.style.display = 'none';

        // Agregar mensaje del usuario
        agregarMensaje(mensaje, 'user');
        estado.conversationHistory.push({ role: 'user', content: mensaje });

        // Mostrar typing
        mostrarTyping();

        // Enviar a la API
        const response = await enviarMensaje(mensaje);

        ocultarTyping();

        if (response.success) {
            console.log('ğŸ€ Tito respuesta:', response);
            console.log('ğŸ€ Productos recibidos:', response.productos);
            agregarMensaje(response.response, 'bot', response.productos);
            estado.conversationHistory.push({ role: 'assistant', content: response.response });
        } else {
            agregarMensaje(response.response || 'DisculpÃ¡, tuve un problemita. Â¿PodÃ©s intentar de nuevo?', 'bot');
        }

        estado.isWaiting = false;
        els.send.disabled = false;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EVENT LISTENERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function initEventListeners() {
        // Toggle chat
        els.toggle.onclick = () => {
            if (estado.chatAbierto) {
                cerrarChat();
            } else {
                abrirChat();
            }
        };

        // Cerrar chat
        els.close.onclick = cerrarChat;

        // Cerrar burbuja
        els.burbujaClose.onclick = ocultarBurbuja;

        // Enviar mensaje
        els.send.onclick = procesarEnvio;

        els.input.onkeypress = (e) => {
            if (e.key === 'Enter') procesarEnvio();
        };

        // Sugerencias
        document.querySelectorAll('.tito-suggestion').forEach(btn => {
            btn.onclick = () => {
                els.input.value = btn.dataset.text;
                procesarEnvio();
            };
        });

        // Cerrar al hacer click fuera
        document.addEventListener('click', (e) => {
            if (estado.chatAbierto && !els.widget.contains(e.target)) {
                cerrarChat();
            }
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SINCRONIZACIÃ“N CON WOOCOMMERCE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function syncWooCommerce() {
        // Escuchar eventos de WooCommerce
        if (typeof jQuery !== 'undefined') {
            jQuery(document.body).on('added_to_cart', function(e, fragments, cart_hash, button) {
                estado.carritoCount++;
                els.toggle.classList.add('cart-added');
                setTimeout(() => els.toggle.classList.remove('cart-added'), 600);

                // Mostrar notificaciÃ³n
                els.notif.textContent = '1';
                els.notif.style.display = 'flex';

                // Burbuja de confirmaciÃ³n
                setTimeout(() => {
                    if (!estado.chatAbierto) {
                        mostrarBurbuja({
                            texto: `ğŸ‰ Â¡GuardiÃ¡n agregado al carrito! Â¿QuerÃ©s completar la adopciÃ³n?`,
                            botones: [
                                { texto: 'Ir al carrito', primary: true, accion: 'url', url: CONFIG.URL_CARRITO },
                                { texto: 'Seguir mirando', accion: 'cerrar' }
                            ]
                        });
                    }
                }, 500);
            });

            jQuery(document.body).on('removed_from_cart', function() {
                estado.carritoCount = Math.max(0, estado.carritoCount - 1);
            });
        }

        // Sincronizar conteo inicial
        obtenerCarritoWoo();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONTADOR DE TIEMPO EN PÃGINA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function iniciarContadorTiempo() {
        setInterval(() => {
            estado.tiempoPagina++;
        }, 1000);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function init() {
        // Esperar a que el DOM estÃ© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
            return;
        }

        console.log('ğŸ€ Tito Ã‰pico v4.0 iniciando...');

        // Inicializar
        initElements();

        estado.visitorId = getVisitorId();
        estado.paginaActual = detectarPagina();
        estado.productoActual = obtenerProductoActual();

        console.log('ğŸ€ PÃ¡gina detectada:', estado.paginaActual);
        if (estado.productoActual) {
            console.log('ğŸ€ Producto:', estado.productoActual.nombre);
        }

        initEventListeners();
        syncWooCommerce();
        iniciarContadorTiempo();
        iniciarBurbujas();
        iniciarDeteccionAbandono();

        console.log('ğŸ€ Tito listo!');
    }

    // Ejecutar
    init();

})();
</script>

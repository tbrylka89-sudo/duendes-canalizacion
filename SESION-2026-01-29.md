# Registro de Sesión - Jueves 29 de Enero 2026

## Resumen General
Implementación completa del sistema de emails transaccionales usando Brevo (ex-Sendinblue) para reemplazar el sistema anterior que usaba Vercel + Resend.

---

## Sistema de Emails Brevo - COMPLETADO

### Archivos Creados/Modificados

| Archivo | Ubicación | Estado |
|---------|-----------|--------|
| `duendes-brevo-emails.php` | `mu-plugins/` | ACTIVO |
| `duendes-emails-unificado.php` | `mu-plugins/` | DESACTIVADO (.DISABLED) |
| `duendes-elementor-emails.php` | `mu-plugins/` | DESACTIVADO (.DISABLED) |

### Plantillas de Email en Brevo

| ID | Nombre | Trigger |
|----|--------|---------|
| 2 | 01 - Bienvenida Tour | Automatización Brevo (suscripción) |
| 12 | 02 - Confirmación Compra | `woocommerce_thankyou` |
| 3 | 03 - Pedido Preparación | `order_status_processing` |
| 4 | 04 - Pedido Enviado | `order_status_completed` |
| 5 | 05 - Pedido Entregado | Manual |
| 6 | 06 - Acceso Mi Magia | `duendes_activar_mi_magia` |
| 7 | 07 - Seguimiento 3 Días | Cron (3 días post-envío) |
| 8 | 08 - Pedir Reseña | Cron (7 días post-envío) |
| 9 | 09 - Newsletter Semanal | Manual/Brevo |
| 10 | 10 - Promoción | Manual/Brevo |
| 11 | 11 - Carrito Abandonado | Automatización Brevo |

### Configuración del Plugin

```php
// Remitente autorizado en Brevo
define('DUENDES_BREVO_SENDER_EMAIL', 'info@duendesdeluruguay.com');
define('DUENDES_BREVO_SENDER_NAME', 'Duendes del Uruguay');

// API Key (configurada en wp-config.php y Vercel env)
define('DUENDES_BREVO_API_KEY', '[CENSURADO - ver wp-config.php]');
```

### Variables de Plantilla (params)

Las plantillas usan la sintaxis `{{ params.VARIABLE }}`:

| Variable | Descripción |
|----------|-------------|
| `{{ params.CUSTOMER_NAME }}` | Nombre del cliente |
| `{{ params.ORDER_NUMBER }}` | Número de orden |
| `{{ params.ORDER_DATE }}` | Fecha de la orden (dd/mm/yyyy) |
| `{{ params.ORDER_ITEMS }}` | Items formateados |
| `{{ params.ORDER_TOTAL }}` | Total formateado ($XX.XX) |
| `{{ params.ORDER_STATUS_URL }}` | URL para ver estado del pedido |
| `{{ params.GUARDIAN_NAME }}` | Nombre del guardián |
| `{{ params.GUARDIAN_IMAGE }}` | URL de imagen del guardián |
| `{{ params.TRACKING_NUMBER }}` | Número de seguimiento |
| `{{ params.TRACKING_URL }}` | URL de tracking |

### Remitentes Autorizados en Brevo

```
✅ info@duendesdeluruguay.com (Duendes del Uruguay) - ACTIVO
✅ tbrylka89@gmail.com (Duendes del Uruguay) - ACTIVO
```

**IMPORTANTE:** Solo estos emails pueden usarse como remitente. Si se usa otro, los emails pueden no enviarse o ir a spam.

---

## Automatizaciones en Brevo

Configuradas directamente en el panel de Brevo (no via API):

1. **Bienvenida** - Se dispara cuando alguien se suscribe a una lista
2. **Carrito Abandonado** - Se dispara automáticamente por el plugin de WooCommerce

---

## Archivos de Plantillas Locales

Ubicación: `/Users/usuario/Desktop/emails-duendes/`

```
01-confirmacion-compra.html  (actualizado con params)
02-bienvenida-tour.html
03-pedido-preparacion.html
04-pedido-enviado.html
05-pedido-entregado.html
06-acceso-mi-magia.html
07-seguimiento-3-dias.html
08-pedir-resena.html
09-newsletter-semanal.html
10-promocion.html
11-carrito-abandonado.html
```

---

## Credenciales

### SFTP
```
Host: 34.70.139.72
Puerto: 55309
Usuario: sftp_live_WfP6i
Contraseña: JzflrSheUnj4itUE27Aqr0SgD3cG5LXhCR
```

### Brevo API
```
API Key: [CENSURADO - ver wp-config.php y Vercel env]
```

---

## Funcionalidades del Plugin

### Emails Automáticos por Eventos WooCommerce

| Hook | Función | Template |
|------|---------|----------|
| `woocommerce_thankyou` | `duendes_brevo_email_confirmacion()` | 12 |
| `woocommerce_order_status_processing` | `duendes_brevo_email_preparacion()` | 3 |
| `woocommerce_order_status_completed` | `duendes_brevo_email_enviado()` | 4 |

### Emails Programados (Cron)

| Acción | Delay | Template |
|--------|-------|----------|
| `duendes_brevo_seguimiento_3_dias` | 3 días post-envío | 7 |
| `duendes_brevo_pedir_resena` | 7 días post-envío | 8 |

### Panel de Admin

Ubicación: **WooCommerce > Brevo Emails**

Funcionalidades:
- Ver estado de la integración
- Ver plantillas configuradas
- Enviar emails de prueba

---

## Emails de WooCommerce Desactivados

El plugin desactiva los emails predeterminados de WooCommerce para evitar duplicados:

```php
add_filter('woocommerce_email_enabled_customer_processing_order', '__return_false');
add_filter('woocommerce_email_enabled_customer_completed_order', '__return_false');
add_filter('woocommerce_email_enabled_customer_on_hold_order', '__return_false');
```

---

## Testing Realizado

- ✅ Email de confirmación de compra enviado correctamente
- ✅ Nombre del cliente aparece correctamente
- ✅ Número de orden aparece correctamente
- ✅ Fecha de orden aparece correctamente
- ✅ Items formateados sin HTML visible
- ✅ Total formateado correctamente
- ✅ Remitente: info@duendesdeluruguay.com

---

## Próximos Pasos Pendientes

- [x] Actualizar las otras plantillas con sintaxis `{{ params.VARIABLE }}` - **COMPLETADO 04:30hs**
- [ ] Testear email de "pedido enviado" con orden real
- [ ] Testear email de "seguimiento 3 días"
- [ ] Configurar DMARC para mejor entregabilidad

---

## Actualización 04:30hs - TODAS LAS PLANTILLAS ACTUALIZADAS

### Plantillas Actualizadas en Brevo

| ID | Nombre | Subject | Variables |
|----|--------|---------|-----------|
| 2 | Bienvenida Tour | Bienvenido/a a la familia Duendes | `CUSTOMER_NAME` |
| 3 | Pedido Preparación | Tu guardián está siendo preparado | `CUSTOMER_NAME`, `ORDER_NUMBER`, `ORDER_STATUS_URL` |
| 4 | Pedido Enviado | ¡Tu guardián está en camino! | `CUSTOMER_NAME`, `TRACKING_NUMBER`, `CARRIER`, `ESTIMATED_DELIVERY`, `TRACKING_URL`, `ORDER_STATUS_URL`, `SHIPPING_NAME`, `SHIPPING_ADDRESS`, `SHIPPING_CITY`, `SHIPPING_COUNTRY` |
| 5 | Pedido Entregado | Tu guardián llegó a casa | `CUSTOMER_NAME` |
| 6 | Acceso Mi Magia | Tu portal Mi Magia está listo | `CUSTOMER_NAME`, `CUSTOMER_EMAIL` |
| 7 | Seguimiento 3 Días | ¿Cómo fue el encuentro? | `CUSTOMER_NAME` |
| 8 | Pedir Reseña | Tu opinión vale oro | `CUSTOMER_NAME`, `REVIEW_URL` |
| 9 | Newsletter Semanal | Los nuevos guardianes de la semana | `CUSTOMER_NAME`, `DATE`, `FEATURED_*`, `PRODUCT2_*`, `PRODUCT3_*` |
| 10 | Promoción | Promoción especial para vos | `CUSTOMER_NAME`, `PROMO_*`, `PRODUCT1_*`, `PRODUCT2_*` |
| 11 | Carrito Abandonado | Tu guardián te está esperando | `CUSTOMER_NAME`, `CART_ITEM_*`, `CART_URL` |
| 12 | Confirmación Compra | Tu guardián te eligió | `CUSTOMER_NAME`, `ORDER_NUMBER`, `ORDER_DATE`, `ORDER_ITEMS`, `ORDER_TOTAL`, `ORDER_STATUS_URL` |

### Archivos Locales Actualizados

Todos los archivos en `/Users/usuario/Desktop/emails-duendes/` fueron actualizados con la sintaxis correcta de Brevo:
- `{{customer.first_name}}` → `{{ params.CUSTOMER_NAME }}`
- `{{order.number}}` → `{{ params.ORDER_NUMBER }}`
- `{{unsubscribe_url}}` → `{{ unsubscribe }}` (variable especial de Brevo)
- Y todas las demás variables correspondientes

### Plugin WordPress Actualizado

El archivo `mu-plugins/duendes-brevo-emails.php` fue actualizado para enviar todos los parámetros necesarios a cada plantilla:
- `duendes_brevo_email_preparacion()` - Ahora incluye `CUSTOMER_NAME`, `ORDER_NUMBER`, `ORDER_STATUS_URL`
- `duendes_brevo_email_enviado()` - Ahora incluye todos los datos de tracking y dirección de envío
- `duendes_brevo_email_seguimiento_3_dias()` - Ahora incluye `CUSTOMER_NAME`
- `duendes_brevo_email_pedir_resena()` - Ahora incluye `CUSTOMER_NAME`
- `duendes_brevo_email_mi_magia()` - Ahora incluye `CUSTOMER_NAME`, `CUSTOMER_EMAIL`
- Nueva función `duendes_brevo_email_entregado()` para envío manual

---

## Actualización 04:50hs - SISTEMA DE EMAILS COMPLETO

### Todos los Emails Configurados en Brevo

| ID | Nombre | Subject | Trigger | Estado |
|----|--------|---------|---------|--------|
| 2 | Bienvenida Tour | Bienvenido/a a la familia Duendes | Automatización Brevo | ✅ |
| 3 | Pedido Preparación | Tu guardián está siendo preparado | `order_status_processing` | ✅ |
| 4 | Pedido Enviado | ¡Tu guardián está en camino! | `order_status_completed` | ✅ |
| 5 | Pedido Entregado | Tu guardián llegó a casa | Manual | ✅ |
| 6 | Acceso Mi Magia | Tu portal Mi Magia está listo | `duendes_activar_mi_magia` | ✅ |
| 7 | Seguimiento 3 Días | ¿Cómo fue el encuentro? | Cron 3 días | ✅ |
| 8 | Pedir Reseña | Tu opinión vale oro | ~~Cron 7 días~~ | ❌ DESACTIVADO |
| 9 | Newsletter Semanal | Los nuevos guardianes | Manual/Brevo | ✅ |
| 10 | Promoción | Promoción especial | Manual/Brevo | ✅ |
| 11 | Carrito Abandonado | Tu guardián te está esperando | Automatización Brevo | ✅ |
| 12 | Confirmación Compra | Tu guardián te eligió | `woocommerce_thankyou` | ✅ |
| 14 | Canalización Preparando | Tu canalización está siendo preparada | Formulario completado | ✅ NUEVO |
| 15 | Canalización Lista | Tu canalización está lista | Admin envía | ✅ NUEVO |

### Links de Mi Magia Corregidos

Todos los emails que mencionan "Mi Magia" ahora apuntan a:
```
https://magia.duendesdeluruguay.com
```

Archivos actualizados:
- Template 5 (Pedido Entregado)
- Template 6 (Acceso Mi Magia)
- Template 7 (Seguimiento 3 días)
- Template 15 (Canalización Lista)
- Plugin WordPress `duendes-brevo-emails.php`

### Flujo Completo de Emails por Compra

```
1. COMPRA
   └── Email: Confirmación de compra (Template 12)

2. FORMULARIO CANALIZACIÓN COMPLETADO
   └── Email: Tu canalización está siendo preparada (Template 14)

3. PEDIDO EN PREPARACIÓN (status: processing)
   └── Email: Tu guardián está siendo preparado (Template 3)

4. PEDIDO ENVIADO (status: completed)
   └── Email: ¡Tu guardián está en camino! (Template 4)
   └── Programa: Seguimiento 3 días (Template 7)

5. ADMIN ENVÍA CANALIZACIÓN
   └── Email: Tu canalización está lista (Template 15)
   └── Canalización disponible en Mi Magia
```

### Archivos Modificados

**WordPress (mu-plugins):**
- `duendes-brevo-emails.php` - Plugin principal con templates 14 y 15
- `duendes-formulario-canalizacion.php` - Hook para email "preparando"

**Vercel:**
- `app/api/admin/canalizaciones/route.js` - Envío de email "lista" cuando admin envía canalización
- Variable de entorno `BREVO_API_KEY` agregada

### Plantillas HTML Locales

Ubicación: `/Users/usuario/Desktop/emails-duendes/`

```
01-confirmacion-compra.html
02-pedido-preparacion.html
03-pedido-enviado.html
04-pedido-entregado.html
05-bienvenida-tour.html
06-acceso-mi-magia.html
07-seguimiento-3dias.html
08-pedido-resenia.html
09-newsletter-semanal.html
10-promocion.html
11-carrito-abandonado.html
12-canalizacion-preparando.html  ← NUEVO
13-canalizacion-lista.html       ← NUEVO
```

---

*Sesión continuada ~04:50hs*
